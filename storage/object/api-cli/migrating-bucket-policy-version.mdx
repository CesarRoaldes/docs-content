---
meta:
  title: Migrating from a bucket policy version to another
  description: This page shows how to migrate from a bucket policy version to a more recent one.
content:
  h1: Migrating from a bucket policy version to another
  paragraph: This page shows how to migrate from a bucket policy version to a more recent one.
tags: object storage object-storage bucket-policy version migrate upgrade
dates:
  validation: 2023-10-18
  posted: 2023-10-02
categories:s
  - storage
  - object-storage
---

Several bucket policy versions coexist in Scaleway Object Storage, and each version has its own mode of operation. A more recent version can help manage the access rights to an existing bucket.

Refer to the [bucket policy versions](/storage/object/api-cli/bucket-policy/#bucket-policy-versions) documentation for more information.

## Retrieving a bucket's policy

1. Open a terminal and run the following command to save the policy of a bucket in a `migrate-policy.json` file:
    ```
    aws s3api get-bucket-policy --bucket <BUCKET_NAME> --query Policy --output text | jq > migrate-policy.json
    ```
2. Open the `migrate-policy.json` file in a code editor. Your current bucket policy displays.

## Migrating from V2 to V3

1. Remove any `Deny` statements from your V2 bucket policy, as they do not have any effects.

2. Replace `2023-04-17` by `2023-06-07-alpha`

3. Replace `Allow` effects by `Deny` effects.

4. Replace the `Action` element by `NotAction` and keep the actions concerned.

5. Replace any `Condition` element by its opposite:
    - `IpAddress` ⇔ `NotIpAddress`
    - `StringEquals` ⇔ `StringNotEquals`
    - `StringEqualsIgnoreCase` ⇔ `StringNotEqualsIgnoreCase`
    - `StringLike` ⇔ `StringNotLike`
    - `DateGreaterThan` ⇔ `DateLessThanEquals`
    - `DateGreaterThanEquals` ⇔ `DateLessThan`
6. Add a new statement to the policy with a `NotPrincipal` element that contains the users and applications concerned.

7. Add an `"Action": "s3:*"` element to the second statement. All actions are denied to eveyone **EXCEPT** users and applications specified in the `NotPrincipal` element.

8. Run the command below to apply the updated policy. Replace `<BUCKET_NAME>` with the name of your bucket.
    ```sh
    aws s3api put-bucket-policy --bucket <BUCKET_NAME> --policy file://migrate-policy.json
    ```
    <Macro id="important-bucket-policy" />

## Bucket policy migration example

The example bucket policy below conforms to the `V2 (2023-04-17)`. The users and application mentioned in the `Principal` element are allowed to perform the specified actions in the specified buckets.

```json
{
    "Version": "2023-04-17",
    "Id": "MyBucketPolicy",
    "Statement": [
        {
            "Sid": "DelegateAccess",
            "Effect": "Allow",
            "Principal": {
                "SCW": "user_id:example-user-d5d70",
                "SCW": "application_id:example-application-d5d70"
            },
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": [
                "example-bucket",
                "example-bucket/*"
            ]
        }
    ]
}
```

The example policy below has the same effect as the V2, but conforms to the V3 (`2023-06-07-alpha`):

- Every action listed in `NotAction` is allowed (as every other action is denied)
- Everybody who is **NOT** the users or applications specified in the `NotPrincipal` element is denied access
 
```json
{
    "Version": "2023-06-07-alpha",
    "Id": "MyBucketPolicy",
    "Statement": [
        {
            "Sid": "Allow specific actions to user and app",
            "Effect": "Deny",
            "Principal": {
                "SCW": "user_id:example-user-d5d70",
                "SCW": "application_id:example-application-d5d70"
            },
            "NotAction":[
                "GetObject",
                "ListObject",
            ],
            "Resource": [
                "example-bucket",
                "example-bucket/*"
            ]
        }
    ],
    "Statement": [
        {
            "Sid": "Deny all EXCEPT user and application",
            "Effect": "Deny",
            "NotPrincipal": {
                "SCW": "user_id:example-user-d5d70",
                "SCW": "application_id:example-application-d5d70"
            },
            "Action": "s3:*",
            "Resource": [
                "example-bucket",
                "example-bucket/*"
            ]
        }
    ]
}
```

<Navigation title="See Also">
    <PreviousButton to="/storage/object/api-cli/combining-iam-and-object-storage">Configuring access with IAM and bucket policies</PreviousButton>
  <NextButton to="/storage/object/api-cli/object-lock/">Setting up object lock</NextButton>
</Navigation>